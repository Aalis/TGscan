{% extends "base.html" %}

{% block title %}TGscan - Parse Comments{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="h4 mb-0">Parse Comments</h2>
                </div>
                <div class="card-body">
                    {% if error %}
                    <div class="alert alert-danger" role="alert">
                        {{ error }}
                    </div>
                    {% endif %}

                    <form action="/comments" method="post" id="parseForm">
                        <div class="mb-3">
                            <label for="chat_id" class="form-label">Channel ID or Username</label>
                            <input type="text" class="form-control" id="chat_id" name="chat_id" required
                                placeholder="Enter channel ID or username (e.g., @channelname)">
                            <div class="form-text">Enter channel ID or username (e.g., @channelname)</div>
                        </div>

                        <div class="mb-3">
                            <label for="message_limit" class="form-label">Number of Posts to Parse</label>
                            <input type="number" class="form-control" id="message_limit" name="message_limit" value="10" min="1" max="100" required>
                            <div class="form-text">Maximum 100 posts</div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="startScanBtn">
                                <i class="fas fa-search me-2"></i>Start Scan
                            </button>
                        </div>
                    </form>

                    <!-- Progress Bar -->
                    <div class="progress mt-4" id="scanProgress" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                             role="progressbar" 
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100" 
                             style="width: 0%">
                            <span class="progress-text">Connecting...</span>
                        </div>
                    </div>
                    <!-- Stage Description -->
                    <div class="text-center mt-2 text-muted small" id="stageDescription" style="display: none;">
                        Establishing connection to Telegram
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Function to verify authentication
async function verifyAuth() {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login';
        return false;
    }

    try {
        const response = await fetch('/auth/me', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_info');
            window.location.href = '/login';
            return false;
        }
        
        return true;
    } catch (error) {
        console.error('Auth verification error:', error);
        localStorage.removeItem('access_token');
        localStorage.removeItem('user_info');
        window.location.href = '/login';
        return false;
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    await verifyAuth();
});

// Handle page visibility changes
document.addEventListener('visibilitychange', async function() {
    if (document.visibilityState === 'visible') {
        await verifyAuth();
    }
});

// Function to update progress bar and stage description
function updateProgress(progress, stage) {
    const progressBar = document.getElementById('scanProgress');
    const progressBarInner = progressBar.querySelector('.progress-bar');
    const stageDescription = document.getElementById('stageDescription');
    const progressText = progressBar.querySelector('.progress-text');
    
    progressBarInner.style.width = `${progress}%`;
    progressBarInner.setAttribute('aria-valuenow', progress);
    progressText.textContent = stage.title;
    stageDescription.textContent = stage.description;
}

// Handle form submission
document.getElementById('parseForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!(await verifyAuth())) {
        return;
    }
    
    const form = this;
    const progressBar = document.getElementById('scanProgress');
    const stageDescription = document.getElementById('stageDescription');
    const submitButton = document.getElementById('startScanBtn');
    const numPosts = parseInt(form.querySelector('#message_limit').value);
    
    // Show progress elements
    progressBar.style.display = 'block';
    stageDescription.style.display = 'block';
    submitButton.disabled = true;

    // Initialize progress tracking
    let currentProgress = 0;
    let currentStage = 0;
    
    const stages = [
        { 
            start: 0,
            end: 15,
            title: 'Connecting...',
            description: 'Establishing connection to Telegram'
        },
        { 
            start: 15,
            end: 30,
            title: 'Loading channel...',
            description: 'Retrieving channel information'
        }
    ];

    // Add dynamic stages for each post
    const postsStartProgress = 30;
    const postsEndProgress = 90;
    const progressPerPost = (postsEndProgress - postsStartProgress) / numPosts;

    for (let i = 0; i < numPosts; i++) {
        stages.push({
            start: postsStartProgress + (i * progressPerPost),
            end: postsStartProgress + ((i + 1) * progressPerPost),
            title: `Processing post ${i + 1}/${numPosts}...`,
            description: `Scanning comments from post ${i + 1} of ${numPosts}`
        });
    }

    // Add final stage
    stages.push({
        start: 90,
        end: 100,
        title: 'Finalizing...',
        description: 'Preparing and saving results'
    });

    // Start progress animation
    const progressInterval = setInterval(() => {
        if (currentStage < stages.length) {
            const stage = stages[currentStage];
            
            if (currentProgress < stage.end) {
                currentProgress = Math.min(currentProgress + 0.5, stage.end);
                updateProgress(currentProgress, {
                    title: stage.title,
                    description: stage.description
                });
            } else {
                currentStage++;
            }
        }
    }, 100);

    try {
        // Submit form data
        const formData = new FormData(form);
        const token = localStorage.getItem('access_token');
        const response = await fetch('/comments', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'text/html'
            },
            body: formData,
            credentials: 'same-origin',
            redirect: 'follow'  // Explicitly follow redirects
        });

        if (!response.ok) {
            clearInterval(progressInterval);
            if (response.status === 401) {
                throw new Error('Authentication failed');
            }
            throw new Error('Failed to parse comments');
        }

        if (response.redirected) {
            clearInterval(progressInterval);
            // Show completion before redirect
            updateProgress(100, {
                title: 'Complete!',
                description: `Successfully processed ${numPosts} posts`
            });
            
            // Short delay to show completion
            await new Promise(resolve => setTimeout(resolve, 500));
            const redirectUrl = new URL(response.url);
            await handleProtectedRoute(redirectUrl.pathname + redirectUrl.search, true);
            return;
        }

    } catch (error) {
        console.error('Error:', error);
        clearInterval(progressInterval);
        if (error.message.includes('Authentication failed')) {
            await verifyAuth();
        } else {
            updateProgress(0, {
                title: 'Error',
                description: error.message || 'An error occurred during scanning'
            });
            setTimeout(resetFormState, 2000);
        }
    }
});

// Function to reset form state
function resetFormState() {
    const form = document.getElementById('parseForm');
    const progressBar = document.getElementById('scanProgress');
    const stageDescription = document.getElementById('stageDescription');
    const submitButton = document.getElementById('startScanBtn');
    
    form.reset();
    progressBar.style.display = 'none';
    stageDescription.style.display = 'none';
    submitButton.disabled = false;
}

// Reset state when page loads
document.addEventListener('DOMContentLoaded', resetFormState);

// Reset state when navigating back
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        resetFormState();
    }
});

// Clean up interval when leaving page
window.addEventListener('beforeunload', function() {
    if (window.progressInterval) {
        clearInterval(window.progressInterval);
    }
});
</script>

<style>
.progress {
    height: 25px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}
.progress-bar {
    font-size: 14px;
    line-height: 25px;
}
.btn:disabled {
    cursor: not-allowed;
    opacity: 0.65;
}
#stageDescription {
    min-height: 20px;
}
</style>
{% endblock %} 